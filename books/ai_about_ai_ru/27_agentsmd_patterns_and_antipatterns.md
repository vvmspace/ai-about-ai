# Паттерны AGENTS.md для реальных репозиториев

Идеальная система инструкций не нужна.
Нужна такая, которая переживает дедлайны и новых участников.

Эта глава — о практичных паттернах `AGENTS.md`
в активных репозиториях.

Если в главе 26 мы определили контракт,
то здесь речь о том,
как эксплуатировать его под давлением.

## Паттерн 1: слоистость файлов при ограниченной глубине

В большинстве проектов достаточно максимум трёх слоёв:

- root-дефолты,
- доменные override,
- локальные исключения для фич.

Слишком плоско — нет локальной точности.
Слишком глубоко — никто не понимает приоритеты.

Простой стек проще аудировать
и быстрее объяснять во время инцидентов.

## Паттерн 2: проверки на уровне конкретных команд

Если quality-gates расплывчаты,
их будут обходить.

Предпочтительно задавать:

- точную команду,
- ожидаемый сигнал успешного прохождения,
- область применения.

Пример:

- в `frontend/`: запускать `pnpm lint && pnpm test`,
- в `infra/`: запускать `terraform validate`,
- в `docs/`: запускать скрипт проверки ссылок.

Так качество превращается из намерения в исполнение.

Для *AI coding workflows*
одна эта привычка предотвращает удивительно много регрессий.

## Паттерн 3: явные no-touch зоны

Агенты быстрые.
И очень буквальные.

Поэтому объявляйте защищённые зоны:

- сгенерированный код,
- историю миграций,
- vendor-снимки,
- юридические текстовые блоки.

Если файлы хрупкие,
говорите это прямо.

## Паттерн 4: fallback-правила при отказе инструментов

Инструменты ломаются.
Это нормально.
Молчание — нет.

Задайте fallback-поведение:

- если e2e недоступны, запускать unit + integration,
- помечать результат как условный,
- добавлять предупреждение в финальный отчёт.

Контролируемая деградация лучше,
чем «фальшиво-зелёные» сборки.

## Паттерн 5: контракт на шаблон результата

Многие команды ограничивают кодинг,
но забывают ограничить отчётность.

Задавайте формат ответа:

- краткие bullets-сводки,
- список изменённых файлов,
- перечень прогнанных тестов,
- известные риски,
- формат ссылок на доказательства.

Ясный output-контракт снижает трение в ревью.

И дополнительно повышает discoverability знаний,
потому что доказательства появляются
в стабильной и поисково-удобной форме.

## Анти-паттерн 1: режим «роман о политике»

Длинные файлы с мотивационными абзацами игнорируются.

Правило:
если строку нельзя проверить или наблюдать,
ей, скорее всего, не место в инструкции.

## Анти-паттерн 2: противоречивые правила

«Двигайтесь быстро» плюс «всегда гоните полный monorepo-check»
для любой микроправки — это не строгость.
Это театр задержек.

Проверки должны соответствовать риску и масштабу.

## Анти-паттерн 3: скрытые приоритеты

Если вложенные override есть,
но они не задокументированы,
и агенты, и люди применяют правила непоследовательно.

Пишите прямо:

«Правила этой папки заменяют root-требования по тестам для локальных doc-only изменений».

## Анти-паттерн 4: нулевая обратная связь от инцидентов

Дефект случился.
Ретро проведено.
`AGENTS.md` не изменился.

Это не continuous improvement.
Это управляемая амнезия.

## Быстрый audit-чеклист

Для каждого слоя `AGENTS.md` спросите:

- scope очевиден из расположения?
- команды исполнимы в указанном виде?
- защищённые пути явно объявлены?
- override задокументированы?
- escalation-триггеры присутствуют?

Если два и более ответа «нет»,
ожидайте нестабильного поведения агентов.

## Минимальный шаблон, который можно переиспользовать

- **Scope**: это дерево директорий.
- **Must do**: обязательные проверки и порядок.
- **Must not do**: явные запреты.
- **When unsure**: условия эскалации.
- **Deliver as**: формат финального результата.

Одна страница. Высокий сигнал.
Без декоративного текста.

В агентных репозиториях качество `AGENTS.md`
определяет качество исполнения.

Не бренд модели.
Не «громкость» промптов.

Лучше локальные инструкции —
лучше локальные результаты.

Продолжение — в [главе 28](./28_agent_to_agent_interaction_protocols.md),
где разбираем, как проектировать аккуратные handoff’ы между агентами поверх этих паттернов.

Оригинал главы на английском: [AGENTS.md Patterns for Real Repositories](../ai_about_ai/27_agentsmd_patterns_and_antipatterns.md).
