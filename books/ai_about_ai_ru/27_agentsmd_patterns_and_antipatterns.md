# Практические паттерны AGENTS.md для живых репозиториев

Вам не нужна идеальная система инструкций.
Нужна та, что выдерживает дедлайны и новых контрибьюторов.

Эта глава про рабочие паттерны `AGENTS.md` в активных репозиториях.

Если в главе 26 мы зафиксировали контракт,
то здесь — как эксплуатировать его под нагрузкой.

## Паттерн 1: слои есть, глубина ограничена

Для большинства проектов достаточно трёх уровней:

- root-дефолты,
- доменные override,
- локальные исключения фичи.

Слишком плоско — нет локальной точности.
Слишком глубоко — никто не понимает приоритеты.

Простой стек легче аудировать
и быстрее объяснять во время инцидента.

## Паттерн 2: проверки на уровне команд

Если quality-gates размыты,
их пропускают.

Предпочтительно указывать:

- точную команду,
- признак успешного прохождения,
- область применения.

Пример:

- в `frontend/`: `pnpm lint && pnpm test`,
- в `infra/`: `terraform validate`,
- в `docs/`: скрипт проверки ссылок.

Так качество превращается из намерения в исполнимое действие.

Для *AI coding workflows* одна эта привычка предотвращает удивительно много регрессий.

## Паттерн 3: явные no-touch зоны

Агенты быстрые.
И при этом буквальные.

Явно объявляйте защищённые области:

- сгенерированный код,
- историю миграций,
- вендорные snapshot,
- юридические блоки текста.

Если файл хрупкий,
скажите это напрямую.

## Паттерн 4: fallback-правила при сбое инструментов

Инструменты ломаются.
Это нормально.
Молчание — нет.

Опишите деградацию заранее:

- если e2e недоступны, запускать unit + integration,
- помечать результат как условный,
- добавлять предупреждение в финальный отчёт.

Контролируемая деградация лучше,
чем фальшиво-зелёные сборки.

## Паттерн 5: контракт формата результата

Многие команды ограничивают кодинг,
но забывают ограничить отчётность.

Фиксируйте формат ответа:

- краткий summary,
- список изменённых файлов,
- какие тесты запускались,
- известные риски,
- формат ссылок на доказательства.

Явный контракт вывода уменьшает friction на ревью.

И дополнительно улучшает discoverability внутреннего знания,
потому что доказательства появляются в стабильной,
поиско-пригодной форме.

## Анти-паттерн 1: режим policy-романа

Длинные мотивирующие тексты игнорируются.

Правило:
если строку нельзя проверить или наблюдать,
ей, вероятно, не место в `AGENTS.md`.

## Анти-паттерн 2: противоречивые инструкции

«Двигайтесь быстро» плюс «всегда гоняйте весь monorepo» даже для микроправки —
это не строгость.
Это театр задержек.

Сопоставляйте проверки с риском и масштабом изменения.

## Анти-паттерн 3: скрытые приоритеты

Если вложенные override есть, но не задокументированы,
люди и агенты будут применять правила по-разному.

Пишите прямо:

«Правила этой папки заменяют root-требования к тестам для локальных doc-only изменений».

## Анти-паттерн 4: отсутствие обратной связи от инцидентов

Дефект случился.
Ретро провели.
`AGENTS.md` не изменился.

Это не continuous improvement.
Это управляемая амнезия.

## Быстрый аудит-чеклист

Для каждого слоя `AGENTS.md` спросите:

- Понятна ли область действия по расположению файла?
- Выполнимы ли команды в текущем виде?
- Явно ли указаны защищённые пути?
- Задокументированы ли override?
- Есть ли escalation-триггеры?

Если два и более ответа «нет»,
ждите непоследовательного поведения агента.

## Минимальный шаблон, который можно переиспользовать

- **Scope**: это дерево директорий.
- **Must do**: обязательные проверки и их порядок.
- **Must not do**: явные запреты.
- **When unsure**: условия эскалации.
- **Deliver as**: формат финального результата.

Одна страница.
Высокий сигнал.
Без декоративного языка.

В агентных репозиториях качество `AGENTS.md`
напрямую задаёт качество исполнения.

Не бренд модели.
Не «громкость» промптов.

Лучшие локальные инструкции —
лучшие локальные результаты.

Далее — материал [Протоколы взаимодействия между агентами в многоагентных системах](./28_agent_to_agent_interaction_protocols.md),
если хотите спроектировать более чистые handoff на этой основе.

Английская версия этой главы: [AGENTS.md Patterns for Real Repositories](../ai_about_ai/27_agentsmd_patterns_and_antipatterns.md).
