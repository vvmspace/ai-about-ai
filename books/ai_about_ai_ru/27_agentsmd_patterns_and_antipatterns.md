# AGENTS.md: паттерны и анти-паттерны

Идеальный `AGENTS.md` не нужен.
Нужен файл,
который выдерживает дедлайны,
новых людей,
и плохие дни инфраструктуры.

Ниже — не теория.
Полевые паттерны,
которые реально работают в проде.

## Паттерн 1: ограниченная слоистость

Рабочий диапазон — до трёх уровней:

- root (общие правила),
- домен (локальная специфика),
- feature (точечные исключения).

Меньше — не хватает точности.
Больше — ломается обозримость.

## Паттерн 2: командный уровень точности

Фраза «прогоните проверки»
не защищает от ошибок.

Нужно писать так:

- какую команду,
- в какой зоне,
- какой pass-критерий,
- что делать при fail.

Именно эта детализация
делает правила исполняемыми.

## Паттерн 3: зоны, которые нельзя трогать

Агент быстрый.
И буквальный.

Если не запретить явно,
он будет редактировать всё,
что кажется уместным.

Фиксируйте отдельно:

- generated,
- миграционные артефакты,
- vendor snapshots,
- регуляторные тексты,
- экспортированные контракты.

## Паттерн 4: fallback-логика при отказе тулов

В реальной жизни инструменты ломаются.

Нормальный `AGENTS.md` отвечает на вопрос:
что делать, когда «нельзя сделать идеально».

Пример:

- e2e недоступны,
- выполняем unit + integration,
- помечаем результат как conditional,
- блокируем релиз без явного human-approve.

Это не компромисс качества.
Это управляемая деградация.

## Паттерн 5: контракт финального ответа

Многие команды контролируют код,
но забывают контролировать отчёт.

В результате ревьюер получает
хаотичный текст
без структуры риска.

Зафиксируйте формат:

- что изменено,
- почему так,
- какие проверки запущены,
- что не удалось запустить,
- какие остаются риски.

## Паттерн 6: правила эскалации по триггеру

Агент должен знать,
когда остановиться.

Хорошие триггеры:

- конфликт требований,
- низкая уверенность в источниках,
- невозможность пройти обязательный gate,
- потенциальный риск безопасности/комплаенса.

Без триггеров он продолжит работу,
даже когда нужно поднять руку.

## Анти-паттерн 1: «политический роман»

Большой файл
с правильными словами,
которые не меняют поведение.

Правило отсечения:
если строку нельзя проверить,
её ценность сомнительна.

## Анти-паттерн 2: противоречивая скорость

«Делай быстро»
и одновременно
«всегда гоняй полный монорепо»
для любой правки.

Это не дисциплина.
Это скрытый саботаж throughput.

Гейт должен соответствовать риску.

## Анти-паттерн 3: скрытые override-правила

Старшие инженеры «знают»,
какое правило важнее,
новые участники и агент — нет.

Итог:
разные решения
на одинаковых задачах.

## Анти-паттерн 4: отсутствие post-incident обновлений

Инцидент случился.
Ретро провели.
`AGENTS.md` не изменился.

Это институциональная амнезия.

## Анти-паттерн 5: ложная автономия

Команда говорит,
что агент автономен,
но любой неожиданный выбор
считается ошибкой.

Если хотите автономию,
опишите decision envelope.

## Быстрый чек-лист качества файла

Проверьте yes/no:

- scope очевиден из пути?
- команды исполнимы как написаны?
- no-touch зоны прописаны?
- fallback-пути есть?
- override-иерархия описана?
- эскалация однозначна?

Если два и более «нет»,
готовьтесь к нестабильному поведению.

## Мини-шаблон, который можно взять в работу

- **Scope**: зона действия.
- **Must**: обязательные действия.
- **Must not**: явные запреты.
- **Checks**: команды + критерии.
- **Fallback**: что делать при недоступности.
- **Escalate when**: триггеры остановки.
- **Delivery format**: структура отчёта.

Одна страница.
Высокий сигнал.

## Главная мысль

`AGENTS.md` — это интерфейс между намерением и исполнением.

Хороший интерфейс
снижает хаос.
Плохой интерфейс
маскирует хаос до релиза.
