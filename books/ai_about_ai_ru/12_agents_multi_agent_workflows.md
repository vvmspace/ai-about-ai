# Проектирование multi-agent workflows

Поисковый ключ: **проектирование multi-agent workflows**

Большинство multi-agent проектов проваливается одинаково:
не из-за слабых моделей,
а из-за мутных передач между этапами.

Агенты расставлены как персонажи сюжета,
а не как операторы производственной линии.

Получается активность без ответственности.

## Оркестрация — это инженерия процесса

Multi-agent система — не «несколько чатов».
Это pipeline обязательств.

Для каждого этапа должны быть определены:

- ожидаемый артефакт,
- критерий приёмки,
- владелец проверки,
- путь отказа/эскалации.

Без этого ошибки проходят дальше тихо и вежливо.

## Начинайте с артефактов, а не с ролей

Частая ошибка: сначала придумывают роли (researcher, writer, reviewer).
Лучше начать с вопроса:

Какой конкретный выход должен существовать после каждого шага?

Пример последовательности:

1. Уточнённый бриф (scope + ограничения + открытые вопросы)
2. Набор доказательств (источники + confidence + пробелы)
3. Черновик (в нужной схеме)
4. Оценка качества (баллы по рубрике + риски)
5. Финальный пакет (approved или escalated)

Роли назначаются после проектирования выходов.

## Handoff-контракты: часто отсутствующий слой

Каждая передача между агентами должна содержать:

- схему payload,
- confidence score,
- нерешённые вопросы,
- ссылки на источники,
- явные допущения.

Если допущения не названы, они станут скрытыми точками отказа.

## Формат коммуникации имеет значение

Свободный текст удобен людям, но неоднозначен для автоматики.
Для повторяющихся цепочек лучше смешанный формат:

- человекочитаемое summary,
- машиночитаемый JSON-блок.

Так поддерживаются и ревью, и автоматизация.

## Quality gates и circuit breakers

Нельзя пускать цепочку без контрольных точек.

Добавьте gate-уровни:

- Gate 1: проверка scope,
- Gate 2: достаточность evidence,
- Gate 3: policy compliance,
- Gate 4: approval перед релизом.

Добавьте стоп-триггеры:

- низкая уверенность,
- конфликт источников,
- отсутствуют обязательные поля,
- неопределённость по политике.

При срабатывании: пауза и эскалация.

## Полевой кейс: закупочный ассистент

Компания собрала цепочку закупок:
intake -> vendor research -> proposal summary -> recommendation.

Сначала передачи были свободным текстом.
Результат: слабая сопоставимость вариантов и периодические промахи по обязательным правилам закупки.

После внедрения handoff-контрактов и gate-проверок:

- качество сравнения выросло,
- policy-миссов стало меньше,
- human-review ускорился благодаря единообразию.

Модели были те же.
Контракт процесса поменял результат.

## Антипаттерны

### 1) Over-agenting
Слишком много узких агентов до валидации базовой надёжности цепочки.

### 2) Скрытые повторы
Агент молча перезапускается, пока «не станет красиво», маскируя нестабильность.

### 3) Нет владельца отказов
При ошибке нельзя определить, какой этап нарушил критерий.

### 4) Нет наблюдаемости стоимости
Не видно token/tool-стоимости по этапам, значит не оптимизировать.

## Практика: редизайн одной цепочки

Для существующего workflow:

1. Карта этапов и артефактов.
2. Формальная handoff-схема на каждый этап.
3. Один quality gate + один circuit breaker.
4. Прогон 15 реальных кейсов.
5. Метрики: error rate, время human-review, стоимость запуска.

Оставляйте решения, которые улучшают все три измерения, а не только одно.

## Governance — часть архитектуры

По мере роста цепочек решения оркестрации становятся решениями управления:

- кто утверждает исключения,
- кто меняет рубрику,
- кто отвечает за качество источников,
- кто ведёт аудит инцидентов.

Без этого orchestration уходит в «племенное знание».

## Ключевая мысль

Эффективность multi-agent — не функция количества агентов.
Это функция качества передач.

Правильные handoff делают средние модели сильными.
Плохие handoff делают сильные модели «сломанных».

Фраза для playbook:

**В агентных системах интерфейс и есть архитектура.**
