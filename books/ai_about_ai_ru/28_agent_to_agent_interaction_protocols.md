# Протоколы взаимодействия между агентами

Когда два агента обмениваются сообщениями без протокола,
это выглядит как кооперация,
но работает как лотерея.

Вежливый тон
не заменяет структурированную передачу ответственности.

## Базовая модель handoff

Каждая передача должна отвечать на пять вопросов:

1. Что требуется сделать?
2. Что именно передано (payload)?
3. Насколько мы уверены (confidence)?
4. Какие риски остались открыты?
5. Какое действие ожидается от получателя?

Если любой пункт пуст,
дальше начинается импровизация.

## Почему свободный текст ломает пайплайн

Свободный текст удобен человеку,
но плохо автоматизируется,
трудно валидируется,
и почти не сравним между прогоном A и B.

В результате:

- невозможно стабильно измерять качество,
- ошибки теряются между этапами,
- повторяемость стремится к нулю.

## Рабочий формат: dual output

Используйте два слоя в каждом сообщении:

- короткий human-summary,
- machine-блок с полями контракта.

Так вы сохраняете:

- скорость человеческого ревью,
- возможность машинной валидации,
- трассируемость решений.

## Контракт полей (минимальный)

В machine-блоке держите:

- `task_intent`,
- `input_artifacts`,
- `assumptions`,
- `confidence_score`,
- `open_questions`,
- `required_next_action`,
- `blocking_conditions`.

Эти поля выглядят «скучно»,
но именно они делают систему надёжной.

## Clarification budget: защита от бесконечных циклов

Без лимита уточнений
агенты начинают «допрашивать» друг друга
и не двигают задачу.

Практика:

- до 3 уточнений,
- после — работа с явными допущениями,
- или эскалация,
если не хватает обязательных данных.

Это сохраняет throughput.

## Confidence: не эмоция, а шкала

Оценка уверенности должна быть калиброванной,
а не словесной.

Пример градации:

- 0.9–1.0: подтверждено источниками,
- 0.7–0.89: достаточно для драфта,
- 0.5–0.69: нужна проверка,
- <0.5: обязательная эскалация.

Тогда downstream-агент
принимает решения по правилу,
а не по интонации текста.

## Ассертивная работа с допущениями

Скрытые допущения — главный переносчик дефектов.

Поэтому каждое допущение должно быть:

- явно перечислено,
- связано с риском,
- помечено как проверенное/непроверенное.

Если допущений нет в сообщении,
они всё равно есть в системе.
Просто невидимые.

## Конфликты между агентами: как разрешать

Сценарий:
один агент говорит «ship»,
второй — «block».

Нужен протокол,
а не спор.

Стандартный порядок:

1. сверка с рубрикой,
2. сравнение силы доказательств,
3. tie-break через независимого критика или человека,
4. логирование основания решения.

Так конфликт становится данными,
а не драмой.

## Набор метрик, который стоит реально вести

Минимальный пакет наблюдаемости:

- handoff rejection rate,
- среднее число уточнений,
- доля скрытых/поздно выявленных допущений,
- escalation frequency,
- cost per accepted artifact.

Без этих метрик
оптимизация превращается в обсуждение «ощущений».

## Частые ошибки внедрения

1. Делают сложную схему,
   но не валидируют обязательные поля.
2. Меряют только итоговый output,
   игнорируя качество передач.
3. Путают вежливость с прозрачностью.
4. Не фиксируют failure path.

## Мини-практикум на 1 неделю

- Возьмите один многоагентный процесс.
- Введите единый handoff-контракт.
- Добавьте confidence-шкалу и clarification budget.
- Прогоните 20 реальных кейсов.
- Сравните reject rate и время до принятого результата.

Обычно эффект виден быстро:
меньше «плавающих» ошибок,
быстрее ревью,
ниже стоимость исправлений.

## Главная мысль

В многоагентной системе
качество взаимодействия = качество протокола.

Не количество агентов.
Не бренд модели.
Именно протокол.
